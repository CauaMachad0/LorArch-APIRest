trigger:
  branches:
    include:
      - master
      - main

variables:
  # Nome da app/ACI e prefixos
  appName: 'myassist554611'         # precisa ser único para DNS
  acrName: 'acrlorch'
  acrLoginServer: 'acrlorch.azurecr.io'
  imageRepository: 'fiap/$(appName)'
  imageTag: '$(Build.BuildId)'
  dockerRegistryServiceConnection: 'sc-acr-lorch'
  azureServiceConnection: 'sc-azure-lorch'
  resourceGroup: 'LorArch'
  location: 'eastus'
  port: '8080'
  healthPath: '/actuator/health'

# Variáveis seguras vindas do Variable Group
variables:
- group: vg-lorarch

pool:
  vmImage: 'ubuntu-latest'

stages:
# ===============================
# CI: Build & Push para ACR
# ===============================
- stage: build_push
  displayName: 'Build & Push (ACR)'
  jobs:
  - job: build_push
    displayName: 'Gerar e enviar imagem Docker'
    steps:
    - task: Docker@2
      displayName: 'Login no ACR'
      inputs:
        command: 'login'
        containerRegistry: '$(dockerRegistryServiceConnection)'

    - task: Docker@2
      displayName: 'Build & Push imagem'
      inputs:
        containerRegistry: '$(dockerRegistryServiceConnection)'
        repository: '$(imageRepository)'
        command: 'buildAndPush'
        Dockerfile: '**/Dockerfile'
        tags: |
          $(imageTag)

    # Exporta metadados da imagem para o próximo stage (não é "artifact", é só logging)
    - bash: |
        echo "##vso[task.setvariable variable=FULL_IMAGE]$(acrLoginServer)/$(imageRepository):$(imageTag)"
        echo "Imagem: $(acrLoginServer)/$(imageRepository):$(imageTag)"
      displayName: 'Exportar referência da imagem'

# ===============================
# CD: Deploy no ACI
# ===============================
- stage: deploy_aci
  displayName: 'Deploy no Azure Container Instance'
  dependsOn: build_push
  jobs:
  - job: deploy
    displayName: 'Criar/Atualizar ACI e Health Check'
    steps:
    - task: AzureCLI@2
      displayName: 'Deploy/Update ACI'
      inputs:
        azureSubscription: '$(azureServiceConnection)'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -e

          echo "Usando imagem $(acrLoginServer)/$(imageRepository):$(imageTag)"

          # Verifica se já existe o container
          if az container show -g $(resourceGroup) -n $(appName) >/dev/null 2>&1; then
            echo "ACI existe. Atualizando com nova imagem..."
            az container update \
              -g $(resourceGroup) -n $(appName) \
              --set containers[0].image=$(acrLoginServer)/$(imageRepository):$(imageTag) \
              --set containers[0].environmentVariables="name=DB_URL value=$(DB_URL)" \
                    "name=DB_USER value=$(DB_USER)" "name=DB_PASSWORD value=$(DB_PASSWORD)"
          else
            echo "Criando ACI..."
            az container create \
              -g $(resourceGroup) -n $(appName) \
              --image $(acrLoginServer)/$(imageRepository):$(imageTag) \
              --cpu 1 --memory 1.5 \
              --dns-name-label $(appName) --ports $(port) \
              --registry-login-server $(acrLoginServer) \
              --registry-username $(acrName) \
              --registry-password $(az acr credential show -n $(acrName) --query passwords[0].value -o tsv) \
              --environment-variables DB_URL="$(DB_URL)" DB_USER="$(DB_USER)" DB_PASSWORD="$(DB_PASSWORD)"
          fi

          echo "Aguardando container iniciar..."
          # Espera IP ou FQDN ficar pronto
          for i in {1..30}; do
            FQDN=$(az container show -g $(resourceGroup) -n $(appName) --query ipAddress.fqdn -o tsv)
            if [ -n "$FQDN" ]; then break; fi
            sleep 5
          done

          if [ -z "$FQDN" ]; then
            echo "FQDN não disponível. Saindo."
            exit 1
          fi

          echo "FQDN: $FQDN"

          # Health check simples no /actuator/health
          echo "Fazendo health check: http://$FQDN:$(port)$(healthPath)"
          for i in {1..30}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "http://$FQDN:$(port)$(healthPath)" || true)
            if [ "$code" = "200" ]; then
              echo "Health OK"
              exit 0
            fi
            echo "Ainda não saudável (HTTP $code)... tentando de novo"
            sleep 7
          done

          echo "Health check falhou após várias tentativas."
          echo "Logs do container:"
          az container logs -g $(resourceGroup) -n $(appName) || true
          exit 1
