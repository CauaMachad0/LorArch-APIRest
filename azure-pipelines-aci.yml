
trigger:
  branches:
    include:
      - main
      - master

pr:
  branches:
    include:
      - main
      - master

pool:
  vmImage: 'ubuntu-latest'

variables:
  appName: 'myassist554611'
  acrName: 'acrlorch'
  acrLoginServer: 'acrlorch.azurecr.io'
  imageRepository: 'fiap/$(appName)'
  imageTag: '$(Build.BuildId)'
  dockerRegistryServiceConnection: 'sc-acr-lorch'
  azureServiceConnection: 'sc-azure-lorch'
  resourceGroup: 'LorArch'
  location: 'eastus'
  containerPort: '8080'

stages:
# ================================
# ETAPA 1 - BUILD e PUSH (ACR)
# ================================
- stage: Build
  displayName: 'Build & Push para o ACR'
  jobs:
    - job: build_push
      displayName: 'Gerar e enviar imagem Docker'
      steps:
        - checkout: self

        - task: Docker@2
          displayName: 'Build & Push imagem no ACR'
          inputs:
            containerRegistry: '$(dockerRegistryServiceConnection)'
            repository: '$(imageRepository)'
            command: 'buildAndPush'
            Dockerfile: 'Dockerfile'
            tags: |
              $(imageTag)

        - script: |
            echo "IMAGE=$(acrLoginServer)/$(imageRepository):$(imageTag)" > build_vars.txt
          displayName: 'Salvar referência da imagem'

        - publish: build_vars.txt
          artifact: image_meta

# ================================
# ETAPA 2 - DEPLOY (ACI)
# ================================
- stage: Deploy
  displayName: 'Deploy no Azure Container Instance'
  dependsOn: Build
  jobs:
    - job: deploy_aci
      displayName: 'Criar Container no Azure'
      steps:
        - download: current
          artifact: image_meta

        - task: AzureCLI@2
          displayName: 'Deploy para Azure Container Instance'
          inputs:
            azureSubscription: '$(azureServiceConnection)'
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              set -e

              RG="$(resourceGroup)"
              ACR="$(acrName)"
              APP="$(appName)"
              LOC="$(location)"
              PORT="$(containerPort)"
              REPO="$(imageRepository)"

              echo "Iniciando deploy no Azure Container Instance..."
              echo "Resource group: $RG | Região: $LOC"

              # Recuperar referência da imagem
              if [ -f "$(Pipeline.Workspace)/image_meta/build_vars.txt" ]; then
                . "$(Pipeline.Workspace)/image_meta/build_vars.txt"
              fi
              if [ -z "$IMAGE" ]; then
                TAG=$(az acr repository show-tags -n "$ACR" --repository "$REPO" --top 1 --orderby time_desc -o tsv)
                IMAGE="${ACR}.azurecr.io/${REPO}:${TAG}"
              fi

              # Pegar credenciais do ACR
              ACR_USER=$(az acr credential show -n "$ACR" --query username -o tsv)
              ACR_PASS=$(az acr credential show -n "$ACR" --query passwords[0].value -o tsv)

              # Apagar container anterior (se existir)
              echo "Removendo container anterior (se existir)..."
              az container delete -g "$RG" -n "$APP" --yes --only-show-errors || true

              # Criar novo container com variáveis do banco
              echo "Criando novo container com imagem: $IMAGE"
              az container create \
                -g "$RG" \
                -n "$APP" \
                --image "$IMAGE" \
                --os-type Linux \
                --cpu 1 --memory 1.5 \
                --ports $PORT \
                --dns-name-label "$APP" \
                --registry-login-server "${ACR}.azurecr.io" \
                --registry-username "$ACR_USER" \
                --registry-password "$ACR_PASS" \
                --environment-variables \
                  DB_URL="$(DB_URL)" \
                  DB_USER="$(DB_USER)" \
                  SPRING_DATASOURCE_URL="$(DB_URL)" \
                  SPRING_DATASOURCE_USERNAME="$(DB_USER)" \
                  SERVER_PORT="$PORT" \
                --secure-environment-variables \
                  DB_PASSWORD="$(DB_PASSWORD)" \
                  SPRING_DATASOURCE_PASSWORD="$(DB_PASSWORD)" \
                --restart-policy Always \
                --location "$LOC"

              echo "Container criado. Buscando URL pública..."
              FQDN=$(az container show -g "$RG" -n "$APP" --query "ipAddress.fqdn" -o tsv)
              echo "Aplicação disponível em: http://$FQDN:$PORT"

              echo "Finalizado com sucesso!"
