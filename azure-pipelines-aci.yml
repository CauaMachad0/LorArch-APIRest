# azure-pipelines-aci.yml

trigger:
  branches:
    include: [ main, master ]

pr:
  branches:
    include: [ main, master ]

variables:
  appName: 'myassist554611'
  acrName: 'acrlorch'
  acrLoginServer: 'acrlorch.azurecr.io'
  imageRepository: 'fiap/$(appName)'
  imageTag: '$(Build.BuildId)'
  dockerRegistryServiceConnection: 'sc-acr-lorch'
  azureServiceConnection: 'sc-azure-lorch'
  resourceGroup: 'LorArch'
  location: 'eastus'
  containerPort: '8080'
  javaVersion: '21'

stages:
# =========================
# 1) TEST
# =========================
- stage: Test
  displayName: 'Testes automatizados'
  jobs:
    - job: unit_tests
      pool: { vmImage: 'ubuntu-latest' }
      steps:
        - checkout: self
          fetchDepth: 0

        - script: mkdir -p ~/.gradle
          displayName: 'Criar cache Gradle'

        - task: Cache@2
          displayName: 'Cache Gradle'
          inputs:
            key: 'gradle | "$(Agent.OS)" | **/gradle*.properties, **/*.gradle*'
            restoreKeys: 'gradle | "$(Agent.OS)"'
            path: ~/.gradle

        - task: JavaToolInstaller@0
          displayName: 'Instalar Java $(javaVersion)'
          inputs:
            versionSpec: '$(javaVersion)'
            jdkArchitectureOption: 'x64'
            jdkSourceOption: 'PreInstalled'

        - script: |
            chmod +x ./gradlew
            ./gradlew test --no-daemon --stacktrace
          displayName: 'Gradle test'

        # Gradle salva JUnit em build/test-results/test/*.xml
        - task: PublishTestResults@2
          condition: always()
          displayName: 'Publicar testes (JUnit)'
          inputs:
            testResultsFiles: '**/build/test-results/test/*.xml'
            testResultsFormat: 'JUnit'
            failTaskOnFailedTests: true

# =========================
# 2) BUILD & PUSH
# =========================
- stage: Build
  displayName: 'Build & Push (ACR)'
  dependsOn: Test
  condition: succeeded()
  jobs:
    - job: build_push
      pool: { vmImage: 'ubuntu-latest' }
      steps:
        - checkout: self

        - task: Docker@2
          displayName: 'Build & Push image'
          inputs:
            containerRegistry: '$(dockerRegistryServiceConnection)'
            repository: '$(imageRepository)'
            command: 'buildAndPush'
            Dockerfile: 'Dockerfile'        # ajuste se o Dockerfile não estiver na raiz
            tags: |
              $(imageTag)
              latest
            addPipelineData: false

        - script: |
            echo "IMAGE=$(acrLoginServer)/$(imageRepository):$(imageTag)" > build_vars.txt
            cat build_vars.txt
          displayName: 'Persistir referência da imagem'

        - publish: build_vars.txt
          artifact: image_meta

# =========================
# 3) DEPLOY (ACI)
# =========================
- stage: Deploy
  displayName: 'Deploy em ACI'
  dependsOn: Build
  condition: succeeded()
  jobs:
    - deployment: deploy_aci
      displayName: 'Deploy ACI'
      environment: 'lorach-aci'
      strategy:
        runOnce:
          deploy:
            steps:
              - download: current
                artifact: image_meta

              - task: AzureCLI@2
                name: setfqdn
                displayName: 'Criar/Atualizar ACI e salvar FQDN'
                inputs:
                  azureSubscription: '$(azureServiceConnection)'
                  scriptType: bash
                  scriptLocation: inlineScript
                  inlineScript: |
                    set -e
                    RG="$(resourceGroup)"
                    ACR="$(acrName)"
                    APP="$(appName)"
                    LOC="$(location)"
                    REPO="$(imageRepository)"
                    PORT="$(containerPort)"

                    if [ -f "$(Pipeline.Workspace)/image_meta/build_vars.txt" ]; then
                      . "$(Pipeline.Workspace)/image_meta/build_vars.txt"
                    fi
                    if [ -z "$IMAGE" ]; then
                      TAG=$(az acr repository show-tags -n "$ACR" --repository "$REPO" --top 1 --orderby time_desc -o tsv)
                      IMAGE="${ACR}.azurecr.io/${REPO}:${TAG}"
                    fi

                    ACR_USER=$(az acr credential show -n "$ACR" --query username -o tsv)
                    ACR_PASS=$(az acr credential show -n "$ACR" --query passwords[0].value -o tsv)

                    DNS_LABEL="${APP}$(Build.BuildId)"
                    az container delete -g "$RG" -n "$APP" --yes --only-show-errors || true

                    az container create \
                      -g "$RG" -n "$APP" \
                      --os-type Linux \
                      --image "$IMAGE" \
                      --registry-login-server "${ACR}.azurecr.io" \
                      --registry-username "$ACR_USER" \
                      --registry-password "$ACR_PASS" \
                      --cpu 1 --memory 1.5 \
                      --ports $PORT \
                      --dns-name-label "$DNS_LABEL" \
                      --restart-policy Always \
                      --environment-variables \
                        DB_URL="$(DB_URL)" \
                        DB_USER="$(DB_USER)" \
                        SPRING_DATASOURCE_URL="$(DB_URL)" \
                        SPRING_DATASOURCE_USERNAME="$(DB_USER)" \
                      --secure-environment-variables \
                        DB_PASSWORD="$(DB_PASSWORD)" \
                        SPRING_DATASOURCE_PASSWORD="$(DB_PASSWORD)" \
                      --location "$LOC"

                    FQDN=$(az container show -g "$RG" -n "$APP" --query "ipAddress.fqdn" -o tsv)
                    echo "##vso[task.setvariable variable=ACI_FQDN;isOutput=true]$FQDN"

              - task: AzureCLI@2
                name: health
                displayName: 'Health check com retry + exportar logs'
                inputs:
                  azureSubscription: '$(azureServiceConnection)'
                  scriptType: bash
                  scriptLocation: inlineScript
                  inlineScript: |
                    set +e
                    RG="$(resourceGroup)"
                    APP="$(appName)"
                    PORT="$(containerPort)"
                    FQDN="$(setfqdn.ACI_FQDN)"

                    echo "Validando http://$FQDN:$PORT/actuator/health"
                    OK=0
                    for i in {1..30}; do
                      RES=$(curl -fsS "http://$FQDN:$PORT/actuator/health" 2>/dev/null)
                      if echo "$RES" | grep -q '"status":"UP"'; then
                        OK=1; break
                      fi
                      echo "Tentativa $i/30... aguardando 7s"
                      sleep 7
                    done

                    mkdir -p $(Pipeline.Workspace)/aci-logs
                    echo "FQDN=$FQDN" > $(Pipeline.Workspace)/aci-logs/fqdn.txt

                    az container logs -g "$RG" -n "$APP" > $(Pipeline.Workspace)/aci-logs/app.log || true
                    az container show -g "$RG" -n "$APP" --query "instanceView.events" -o table \
                      > $(Pipeline.Workspace)/aci-logs/events.txt || true

                    if [ "$OK" -ne 1 ]; then
                      echo "##vso[task.logissue type=error]Health check falhou em http://$FQDN:$PORT/actuator/health"
                      exit 1
                    fi

              - task: PublishBuildArtifacts@1
                condition: always()
                displayName: 'Publicar logs/FQDN'
                inputs:
                  PathtoPublish: '$(Pipeline.Workspace)/aci-logs'
                  ArtifactName: 'aci_logs'
                  publishLocation: 'Container'

              - task: Bash@3
                condition: always()
                displayName: 'Gerar resumo para evidência'
                inputs:
                  targetType: inline
                  script: |
                    FQDN=$(cat "$(Pipeline.Workspace)/aci-logs/fqdn.txt" | cut -d'=' -f2-)
                    echo "### CI/CD – Sprint 4 (DevOps & Cloud)" > summary.md
                    echo "- **FQDN (ACI):** http://$FQDN:$(containerPort)" >> summary.md
                    echo "- **Imagem:** $(acrLoginServer)/$(imageRepository):$(imageTag)" >> summary.md
                    echo "- **Resource Group:** $(resourceGroup)" >> summary.md
                    echo "- **Região:** $(location)" >> summary.md
                    echo "- **Repositório ACR:** $(acrName)" >> summary.md
                    echo "- **Pipeline Run:** $(Build.BuildNumber)" >> summary.md
                    echo "_Secrets usados: DB_URL, DB_USER, DB_PASSWORD (secure)._ " >> summary.md

              - task: PublishBuildArtifacts@1
                condition: always()
                displayName: 'Publicar resumo'
                inputs:
                  PathtoPublish: 'summary.md'
                  ArtifactName: 'evidencias'
                  publishLocation: 'Container'
